# Non regression tests

function(yabmp_add_info_test file)
	set(options FAILS STDIN)
  cmake_parse_arguments(MY_TEST "${options}" "" "" ${ARGN} )
	
	set(INPUT ${CMAKE_CURRENT_SOURCE_DIR}/input/${file})
	get_filename_component(OUTPUTDIR ${CMAKE_CURRENT_BINARY_DIR}/${file} DIRECTORY)
	if (NOT EXISTS "${OUTPUTDIR}")
		file(MAKE_DIRECTORY "${OUTPUTDIR}")
	endif()
	
	set(NAME_SUFFIX)
	if(MY_TEST_STDIN)
		set(NAME_SUFFIX "-stdin")
		file(WRITE "${CMAKE_CURRENT_BINARY_DIR}/${file}${NAME_SUFFIX}-info.cmake" "execute_process(COMMAND \"\${YABMP_INFO}\" -o \"${CMAKE_CURRENT_BINARY_DIR}/${file}${NAME_SUFFIX}.info.txt\" \"-\" INPUT_FILE ${INPUT} RESULT_VARIABLE PROC_RESULT ERROR_VARIABLE PROC_ERROR)\nif(PROC_RESULT)\nmessage(FATAL_ERROR \"\${PROC_ERROR}\${YABMP_INFO} exited with result \${PROC_RESULT}\")\nendif()")
		add_test(NAME ${file}${NAME_SUFFIX}-info COMMAND "${CMAKE_COMMAND}" "-DYABMP_INFO:FILEPATH=$<TARGET_FILE:yabmpinfo>" -P "${CMAKE_CURRENT_BINARY_DIR}/${file}${NAME_SUFFIX}.cmake" )
	else()
		add_test(NAME ${file}-info COMMAND yabmpinfo -o "${CMAKE_CURRENT_BINARY_DIR}/${file}${NAME_SUFFIX}.info.txt" "${INPUT}" )
	endif()
	set_tests_properties(${file}-info PROPERTIES WILL_FAIL ${MY_TEST_FAILS})
	if (NOT MY_TEST_FAILS)
		add_test(NAME ${file}${NAME_SUFFIX}-info-compare COMMAND "${CMAKE_COMMAND}" -E compare_files "${CMAKE_CURRENT_SOURCE_DIR}/expected/${file}.info.txt" "${CMAKE_CURRENT_BINARY_DIR}/${file}${NAME_SUFFIX}.info.txt")
		set_tests_properties(${file}${NAME_SUFFIX}-info-compare PROPERTIES DEPENDS ${file}${NAME_SUFFIX}-info)
	endif()
endfunction()

function(yabmp_add_test file)
	set(options EXPANDPALETTE KEEPPALETTE FAILS STDINOUT NOSEEK)
  cmake_parse_arguments(MY_TEST "${options}" "" "" ${ARGN} )
  
  set(INPUT ${CMAKE_CURRENT_SOURCE_DIR}/input/${file})
  
  set(OTHER_ARGS)
  set(NAME_SUFFIX)
  if (MY_TEST_EXPANDPALETTE)
  	list(APPEND OTHER_ARGS "--expand-palette")
  	set(NAME_SUFFIX "${NAME_SUFFIX}-expand-palette")
  endif()
  if (MY_TEST_KEEPPALETTE)
  	list(APPEND OTHER_ARGS "--keep-palette")
  	set(NAME_SUFFIX "${NAME_SUFFIX}-keep-palette")
  endif()
  
	if(MY_TEST_STDINOUT)
		set(NAME_SUFFIX2 "-stdinout")
		if(MY_TEST_NOSEEK)
			set(NAME_SUFFIX2 "${NAME_SUFFIX2}-no-seek")
			list(APPEND OTHER_ARGS "--no-seek")
		endif()
		file(WRITE "${CMAKE_CURRENT_BINARY_DIR}/${file}${NAME_SUFFIX}${NAME_SUFFIX2}-convert.cmake" "execute_process(COMMAND \"\${YABMP_CONVERT}\" -i - -o - \"-\" ${OTHER_ARGS} INPUT_FILE ${INPUT} OUTPUT_FILE \"${CMAKE_CURRENT_BINARY_DIR}/${file}${NAME_SUFFIX}${NAME_SUFFIX2}.png\" RESULT_VARIABLE PROC_RESULT ERROR_VARIABLE PROC_ERROR)\nif(PROC_RESULT)\nmessage(FATAL_ERROR \"\${PROC_ERROR}\${YABMP_CONVERT} exited with result \${PROC_RESULT}\")\nendif()")
		add_test(NAME ${file}${NAME_SUFFIX}${NAME_SUFFIX2}-convert COMMAND "${CMAKE_COMMAND}" "-DYABMP_CONVERT:FILEPATH=$<TARGET_FILE:yabmpconvert>" -P "${CMAKE_CURRENT_BINARY_DIR}/${file}${NAME_SUFFIX}${NAME_SUFFIX2}-convert.cmake" )
	else()
		add_test(NAME ${file}${NAME_SUFFIX}-convert COMMAND yabmpconvert -i "${INPUT}" -o "${CMAKE_CURRENT_BINARY_DIR}/${file}${NAME_SUFFIX}.png" ${OTHER_ARGS})
	endif()
	
	set_tests_properties(${file}${NAME_SUFFIX}${NAME_SUFFIX2}-convert PROPERTIES WILL_FAIL ${MY_TEST_FAILS})
	if (NOT MY_TEST_FAILS)
		add_test(NAME ${file}${NAME_SUFFIX}${NAME_SUFFIX2}-convert-compare COMMAND "${CMAKE_COMMAND}" -E compare_files "${CMAKE_CURRENT_SOURCE_DIR}/expected/${file}${NAME_SUFFIX}.png" "${CMAKE_CURRENT_BINARY_DIR}/${file}${NAME_SUFFIX}${NAME_SUFFIX2}.png")
		set_tests_properties(${file}${NAME_SUFFIX}${NAME_SUFFIX2}-convert-compare PROPERTIES DEPENDS ${file}${NAME_SUFFIX}${NAME_SUFFIX2}-convert)
	endif()
endfunction()

# bmpsuite good tests
yabmp_add_info_test("bmpsuite/g/pal1.bmp")
yabmp_add_info_test("bmpsuite/g/pal1.bmp" STDIN)
yabmp_add_test("bmpsuite/g/pal1.bmp")
yabmp_add_test("bmpsuite/g/pal1.bmp" EXPANDPALETTE)
yabmp_add_test("bmpsuite/g/pal1.bmp" KEEPPALETTE)
yabmp_add_info_test("bmpsuite/g/pal1bg.bmp")
yabmp_add_test("bmpsuite/g/pal1bg.bmp" EXPANDPALETTE)
yabmp_add_test("bmpsuite/g/pal1bg.bmp")
yabmp_add_info_test("bmpsuite/g/pal1wb.bmp")
yabmp_add_test("bmpsuite/g/pal1wb.bmp")
yabmp_add_info_test("bmpsuite/g/pal4.bmp")
yabmp_add_test("bmpsuite/g/pal4.bmp")
yabmp_add_test("bmpsuite/g/pal4.bmp" EXPANDPALETTE)
yabmp_add_info_test("bmpsuite/g/pal4gs.bmp")
yabmp_add_test("bmpsuite/g/pal4gs.bmp")
yabmp_add_test("bmpsuite/g/pal4gs.bmp" EXPANDPALETTE)
yabmp_add_test("bmpsuite/g/pal4gs.bmp" KEEPPALETTE)
yabmp_add_info_test("bmpsuite/g/pal4rle.bmp")
yabmp_add_test("bmpsuite/g/pal4rle.bmp")
yabmp_add_test("bmpsuite/g/pal4rle.bmp" EXPANDPALETTE)
yabmp_add_info_test("bmpsuite/g/pal8-0.bmp")
yabmp_add_test("bmpsuite/g/pal8-0.bmp")
yabmp_add_info_test("bmpsuite/g/pal8.bmp")
yabmp_add_test("bmpsuite/g/pal8.bmp")
yabmp_add_test("bmpsuite/g/pal8.bmp" EXPANDPALETTE)
yabmp_add_info_test("bmpsuite/g/pal8gs.bmp")
yabmp_add_test("bmpsuite/g/pal8gs.bmp")
yabmp_add_test("bmpsuite/g/pal8gs.bmp" EXPANDPALETTE)
yabmp_add_test("bmpsuite/g/pal8gs.bmp" KEEPPALETTE)
yabmp_add_info_test("bmpsuite/g/pal8nonsquare.bmp")
yabmp_add_test("bmpsuite/g/pal8nonsquare.bmp")
yabmp_add_info_test("bmpsuite/g/pal8os2.bmp")
yabmp_add_test("bmpsuite/g/pal8os2.bmp")
yabmp_add_info_test("bmpsuite/g/pal8rle.bmp")
yabmp_add_test("bmpsuite/g/pal8rle.bmp")
yabmp_add_test("bmpsuite/g/pal8rle.bmp" EXPANDPALETTE)
yabmp_add_info_test("bmpsuite/g/pal8topdown.bmp")
yabmp_add_test("bmpsuite/g/pal8topdown.bmp")
yabmp_add_info_test("bmpsuite/g/pal8v4.bmp")
yabmp_add_test("bmpsuite/g/pal8v4.bmp")
yabmp_add_info_test("bmpsuite/g/pal8v5.bmp")
yabmp_add_test("bmpsuite/g/pal8v5.bmp")
yabmp_add_info_test("bmpsuite/g/pal8w124.bmp")
yabmp_add_test("bmpsuite/g/pal8w124.bmp")
yabmp_add_info_test("bmpsuite/g/pal8w125.bmp")
yabmp_add_test("bmpsuite/g/pal8w125.bmp")
yabmp_add_info_test("bmpsuite/g/pal8w126.bmp")
yabmp_add_test("bmpsuite/g/pal8w126.bmp")
yabmp_add_info_test("bmpsuite/g/rgb16-565.bmp")
yabmp_add_test("bmpsuite/g/rgb16-565.bmp")
yabmp_add_info_test("bmpsuite/g/rgb16-565pal.bmp")
yabmp_add_test("bmpsuite/g/rgb16-565pal.bmp")
yabmp_add_info_test("bmpsuite/g/rgb16.bmp")
yabmp_add_test("bmpsuite/g/rgb16.bmp")
yabmp_add_info_test("bmpsuite/g/rgb24.bmp")
yabmp_add_test("bmpsuite/g/rgb24.bmp")
yabmp_add_info_test("bmpsuite/g/rgb24pal.bmp")
yabmp_add_test("bmpsuite/g/rgb24pal.bmp")
yabmp_add_info_test("bmpsuite/g/rgb32.bmp")
yabmp_add_test("bmpsuite/g/rgb32.bmp")
yabmp_add_info_test("bmpsuite/g/rgb32bf.bmp")
yabmp_add_test("bmpsuite/g/rgb32bf.bmp")

# bmpsuite questionable tests
yabmp_add_info_test("bmpsuite/q/pal1p1.bmp")
yabmp_add_test("bmpsuite/q/pal1p1.bmp")
yabmp_add_info_test("bmpsuite/q/pal2.bmp")
yabmp_add_test("bmpsuite/q/pal2.bmp")
yabmp_add_test("bmpsuite/q/pal2.bmp" KEEPPALETTE)
yabmp_add_test("bmpsuite/q/pal2.bmp" EXPANDPALETTE)
yabmp_add_info_test("bmpsuite/q/pal2color.bmp")
yabmp_add_test("bmpsuite/q/pal2color.bmp")
yabmp_add_test("bmpsuite/q/pal2color.bmp" EXPANDPALETTE)
yabmp_add_info_test("bmpsuite/q/pal4rletrns.bmp")
yabmp_add_test("bmpsuite/q/pal4rletrns.bmp")
yabmp_add_info_test("bmpsuite/q/pal8offs.bmp")
yabmp_add_test("bmpsuite/q/pal8offs.bmp")
yabmp_add_info_test("bmpsuite/q/pal8os2sp.bmp")
yabmp_add_test("bmpsuite/q/pal8os2sp.bmp")
yabmp_add_info_test("bmpsuite/q/pal8os2v2-16.bmp")
yabmp_add_test("bmpsuite/q/pal8os2v2-16.bmp")
yabmp_add_info_test("bmpsuite/q/pal8os2v2.bmp")
yabmp_add_test("bmpsuite/q/pal8os2v2.bmp")
yabmp_add_info_test("bmpsuite/q/pal8oversizepal.bmp")
yabmp_add_test("bmpsuite/q/pal8oversizepal.bmp")
yabmp_add_info_test("bmpsuite/q/pal8rletrns.bmp")
yabmp_add_test("bmpsuite/q/pal8rletrns.bmp")
yabmp_add_info_test("bmpsuite/q/rgb16-231.bmp")
yabmp_add_test("bmpsuite/q/rgb16-231.bmp")
yabmp_add_info_test("bmpsuite/q/rgb16-3103.bmp")
yabmp_add_test("bmpsuite/q/rgb16-3103.bmp")
yabmp_add_info_test("bmpsuite/q/rgb24jpeg.bmp")
yabmp_add_test("bmpsuite/q/rgb24jpeg.bmp" FAILS)
yabmp_add_info_test("bmpsuite/q/rgb24largepal.bmp")
yabmp_add_test("bmpsuite/q/rgb24largepal.bmp")
yabmp_add_test("bmpsuite/q/rgb24largepal.bmp" STDINOUT)
yabmp_add_test("bmpsuite/q/rgb24largepal.bmp" STDINOUT NOSEEK)
yabmp_add_info_test("bmpsuite/q/rgb24lprof.bmp")
yabmp_add_test("bmpsuite/q/rgb24lprof.bmp")
yabmp_add_info_test("bmpsuite/q/rgb24png.bmp")
yabmp_add_test("bmpsuite/q/rgb24png.bmp" FAILS)
yabmp_add_info_test("bmpsuite/q/rgb24prof.bmp")
yabmp_add_test("bmpsuite/q/rgb24prof.bmp")
yabmp_add_info_test("bmpsuite/q/rgb32-111110.bmp")
yabmp_add_test("bmpsuite/q/rgb32-111110.bmp")
yabmp_add_info_test("bmpsuite/q/rgb32-7187.bmp")
yabmp_add_test("bmpsuite/q/rgb32-7187.bmp" FAILS)
yabmp_add_info_test("bmpsuite/q/rgb32fakealpha.bmp")
yabmp_add_test("bmpsuite/q/rgb32fakealpha.bmp")
yabmp_add_info_test("bmpsuite/q/rgba16-4444.bmp")
yabmp_add_test("bmpsuite/q/rgba16-4444.bmp")
yabmp_add_info_test("bmpsuite/q/rgba16-1924.bmp")
yabmp_add_test("bmpsuite/q/rgba16-1924.bmp")
yabmp_add_info_test("bmpsuite/q/rgba32.bmp")
yabmp_add_test("bmpsuite/q/rgba32.bmp")
yabmp_add_info_test("bmpsuite/q/rgba32-61754.bmp")
yabmp_add_test("bmpsuite/q/rgba32-61754.bmp" FAILS)
yabmp_add_info_test("bmpsuite/q/rgba32-81284.bmp")
yabmp_add_test("bmpsuite/q/rgba32-81284.bmp")
yabmp_add_info_test("bmpsuite/q/rgba32abf.bmp")
yabmp_add_test("bmpsuite/q/rgba32abf.bmp" FAILS)


# bmpsuite bad tests
yabmp_add_info_test("bmpsuite/b/badbitcount.bmp")
yabmp_add_test("bmpsuite/b/badbitcount.bmp" FAILS)
yabmp_add_info_test("bmpsuite/b/badbitssize.bmp")
yabmp_add_test("bmpsuite/b/badbitssize.bmp")
yabmp_add_info_test("bmpsuite/b/baddens1.bmp")
yabmp_add_test("bmpsuite/b/baddens1.bmp")
yabmp_add_info_test("bmpsuite/b/baddens2.bmp")
yabmp_add_test("bmpsuite/b/baddens2.bmp")
yabmp_add_info_test("bmpsuite/b/badfilesize.bmp")
yabmp_add_test("bmpsuite/b/badfilesize.bmp")
yabmp_add_info_test("bmpsuite/b/badheadersize.bmp" FAILS)
yabmp_add_test("bmpsuite/b/badheadersize.bmp" FAILS)
yabmp_add_info_test("bmpsuite/b/badpalettesize.bmp" FAILS)
yabmp_add_test("bmpsuite/b/badpalettesize.bmp" FAILS)
yabmp_add_info_test("bmpsuite/b/badplanes.bmp")
yabmp_add_test("bmpsuite/b/badplanes.bmp" FAILS)
yabmp_add_info_test("bmpsuite/b/badrle.bmp")
yabmp_add_test("bmpsuite/b/badrle.bmp" FAILS)
yabmp_add_info_test("bmpsuite/b/badwidth.bmp")
yabmp_add_test("bmpsuite/b/badwidth.bmp" FAILS)
yabmp_add_info_test("bmpsuite/b/pal8badindex.bmp")
yabmp_add_test("bmpsuite/b/pal8badindex.bmp" FAILS)
yabmp_add_info_test("bmpsuite/b/reallybig.bmp")
yabmp_add_test("bmpsuite/b/reallybig.bmp" FAILS)
yabmp_add_info_test("bmpsuite/b/rletopdown.bmp")
yabmp_add_test("bmpsuite/b/rletopdown.bmp")
yabmp_add_info_test("bmpsuite/b/shortfile.bmp")
yabmp_add_test("bmpsuite/b/shortfile.bmp" FAILS)

# fuzzer tests
include (${CMAKE_ROOT}/Modules/CheckTypeSize.cmake)
set(YABMP_32BITS_LONG_FAILS)
check_type_size(long YABMP_SIZEOF_LONG BUILTIN_TYPES_ONLY LANGUAGE C)
if(${YABMP_SIZEOF_LONG} LESS 8)
	set(YABMP_32BITS_LONG_FAILS FAILS)
endif()
yabmp_add_info_test("fuzzer/fuzzer-000000.bmp")
yabmp_add_test("fuzzer/fuzzer-000000.bmp" FAILS)
yabmp_add_info_test("fuzzer/fuzzer-000001.bmp")
yabmp_add_test("fuzzer/fuzzer-000001.bmp" FAILS)
yabmp_add_info_test("fuzzer/fuzzer-000002.bmp")
yabmp_add_test("fuzzer/fuzzer-000002.bmp" FAILS)
yabmp_add_info_test("fuzzer/fuzzer-000003.bmp")
yabmp_add_test("fuzzer/fuzzer-000003.bmp" FAILS)
yabmp_add_info_test("fuzzer/fuzzer-000004.bmp" ${YABMP_32BITS_LONG_FAILS})
yabmp_add_test("fuzzer/fuzzer-000004.bmp" FAILS)
yabmp_add_info_test("fuzzer/fuzzer-000005.bmp")
yabmp_add_test("fuzzer/fuzzer-000005.bmp" FAILS)
yabmp_add_info_test("fuzzer/fuzzer-000006.bmp" ${YABMP_32BITS_LONG_FAILS})
yabmp_add_test("fuzzer/fuzzer-000006.bmp" FAILS)
yabmp_add_info_test("fuzzer/fuzzer-000007.bmp")
yabmp_add_test("fuzzer/fuzzer-000007.bmp" FAILS)
yabmp_add_info_test("fuzzer/fuzzer-000008.bmp" ${YABMP_32BITS_LONG_FAILS})
yabmp_add_test("fuzzer/fuzzer-000008.bmp" FAILS)
yabmp_add_info_test("fuzzer/fuzzer-000009.bmp")
yabmp_add_test("fuzzer/fuzzer-000009.bmp" FAILS)
yabmp_add_info_test("fuzzer/fuzzer-000010.bmp")
yabmp_add_test("fuzzer/fuzzer-000010.bmp" FAILS)
yabmp_add_info_test("fuzzer/fuzzer-000011.bmp")
yabmp_add_test("fuzzer/fuzzer-000011.bmp" FAILS)
yabmp_add_info_test("fuzzer/fuzzer-000012.bmp" ${YABMP_32BITS_LONG_FAILS})
yabmp_add_test("fuzzer/fuzzer-000012.bmp" FAILS)
yabmp_add_info_test("fuzzer/fuzzer-000013.bmp")
yabmp_add_test("fuzzer/fuzzer-000013.bmp" FAILS)
yabmp_add_info_test("fuzzer/fuzzer-000014.bmp")
yabmp_add_test("fuzzer/fuzzer-000014.bmp" FAILS)
yabmp_add_info_test("fuzzer/fuzzer-000015.bmp")
yabmp_add_test("fuzzer/fuzzer-000015.bmp" FAILS)
yabmp_add_info_test("fuzzer/fuzzer-000016.bmp")
yabmp_add_test("fuzzer/fuzzer-000016.bmp" FAILS)
yabmp_add_info_test("fuzzer/fuzzer-000017.bmp" ${YABMP_32BITS_LONG_FAILS})
yabmp_add_test("fuzzer/fuzzer-000017.bmp" FAILS)

